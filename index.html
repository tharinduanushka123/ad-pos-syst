<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üîß Advanced Repair Shop POS</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
.container { max-width: 1400px; margin: 0 auto; }

/* Header */
.header { background: white; color: #333; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
.header h1 { font-size: 32px; color: #667eea; margin-bottom: 5px; }
.header p { color: #666; }
.shop-info { text-align: right; }
.shop-info h3 { color: #667eea; margin-bottom: 5px; }
.shop-info p { font-size: 13px; color: #666; }

/* Dashboard Cards */
.dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
.dash-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; }
.dash-card h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
.dash-card .value { font-size: 28px; font-weight: bold; color: #667eea; }
.dash-card.sales { border-left: 4px solid #4CAF50; }
.dash-card.weekly { border-left: 4px solid #2196F3; }
.dash-card.monthly { border-left: 4px solid #FF9800; }
.dash-card.items { border-left: 4px solid #9C27B0; }
.dash-card.orders { border-left: 4px solid #FF5722; }
.dash-card.stock { border-left: 4px solid #F44336; }

/* Main Layout */
.main { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

/* Sections */
.section { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

/* Tabs */
.tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.tab { padding: 12px 20px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
.tab:hover { background: #e0e0e0; }
.tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }

/* Search Bar */
.search-bar { margin-bottom: 15px; }
.search-bar input { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
.search-bar input:focus { outline: none; border-color: #667eea; }

/* Product Grid */
.product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; max-height: 500px; overflow-y: auto; padding: 5px; }
.product-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative; }
.product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
.product-card.out { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); opacity: 0.7; cursor: not-allowed; }
.product-card.low { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.product-card h3 { font-size: 15px; margin-bottom: 8px; }
.product-card .price { font-size: 18px; font-weight: bold; margin: 8px 0; }
.product-card .stock { background: rgba(255,255,255,0.25); padding: 4px 10px; border-radius: 12px; font-size: 11px; display: inline-block; }
.product-card .category { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.3); padding: 3px 8px; border-radius: 10px; font-size: 10px; }

/* Forms */
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 13px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* Buttons */
.btn { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
.btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.btn-red { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
.btn-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.btn-orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.btn-small { padding: 6px 12px; font-size: 12px; width: auto; }
.btn-block { width: 100%; }

/* Cart */
.cart-items { max-height: 300px; overflow-y: auto; }
.cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: #f8f9fa; margin-bottom: 8px; border-radius: 8px; }
.cart-item-info { flex: 1; }
.cart-item-name { font-weight: 600; color: #333; font-size: 13px; }
.cart-item-price { color: #667eea; font-size: 12px; }
.cart-controls { display: flex; align-items: center; gap: 5px; }
.qty-btn { background: #667eea; color: white; border: none; width: 26px; height: 26px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 14px; }
.qty-btn:hover { background: #764ba2; }
.remove-btn { background: #f44336; color: white; border: none; width: 26px; height: 26px; border-radius: 50%; cursor: pointer; font-weight: bold; }

/* Cart Summary */
.cart-summary { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px; }
.summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
.summary-row.total { font-size: 18px; font-weight: bold; color: #667eea; border-top: 2px solid #ddd; padding-top: 10px; margin-top: 10px; }

.cart-total { font-size: 28px; font-weight: bold; text-align: right; margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; }

/* Stock Panel */
.stock-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: #f8f9fa; margin-bottom: 8px; border-radius: 8px; }
.stock-info { flex: 1; }
.stock-name { font-weight: 600; color: #333; }
.stock-details { font-size: 12px; color: #666; margin-top: 3px; }
.stock-actions { display: flex; gap: 5px; }

/* Tables */
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
th { background: #f8f9fa; font-weight: 600; color: #333; font-size: 13px; }
td { font-size: 13px; }
tr:hover { background: #f8f9fa; }

/* Receipt */
.receipt { background: white; padding: 30px; margin-top: 20px; border-radius: 10px; border: 3px solid #667eea; display: none; }
.receipt.show { display: block; }
.receipt-header { text-align: center; border-bottom: 2px dashed #667eea; padding-bottom: 15px; margin-bottom: 15px; }
.receipt-logo { font-size: 40px; margin-bottom: 10px; }
.receipt-shop { font-size: 20px; font-weight: bold; color: #667eea; }
.receipt-details { font-size: 12px; color: #666; margin-top: 5px; }
.receipt-info { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 12px; color: #666; }
.receipt-items { margin-bottom: 15px; }
.receipt-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #ddd; font-size: 13px; }
.receipt-totals { border-top: 2px dashed #667eea; padding-top: 15px; }
.receipt-total-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }
.receipt-total-row.final { font-size: 18px; font-weight: bold; color: #667eea; margin-top: 10px; padding-top: 10px; border-top: 2px solid #667eea; }
.receipt-footer { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 2px dashed #667eea; font-size: 12px; color: #666; }
.receipt-barcode { text-align: center; margin: 15px 0; font-family: 'Courier New', monospace; font-size: 14px; letter-spacing: 3px; }

/* Alerts */
.alert { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; font-weight: 600; }
.alert-warning { background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
.alert-danger { background: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
.alert-success { background: #d4edda; border-left: 4px solid #28a745; color: #155724; }

/* Hidden */
.hidden { display: none !important; }

/* Empty State */
.empty-state { text-align: center; padding: 50px 20px; color: #999; }
.empty-state h3 { color: #666; margin-bottom: 10px; }

/* Modal */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
.modal.show { display: flex; }
.modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-header h2 { color: #667eea; }
.close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }

/* Payment Methods */
.payment-methods { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
.payment-method { padding: 15px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; }
.payment-method:hover { border-color: #667eea; }
.payment-method.selected { border-color: #667eea; background: #f0f4ff; }
.payment-method i { font-size: 24px; margin-bottom: 5px; display: block; }

/* ==================== PRINT STYLES - ONLY RECEIPT PRINTS ==================== */
@media print {
    body * {
        visibility: hidden !important;
    }
    
    .receipt, .receipt * {
        visibility: visible !important;
    }
    
    .receipt {
        display: block !important;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 20px;
        border: 2px solid #000;
        box-shadow: none;
        background: white;
        color: black;
    }
    
    .no-print, 
    .header, 
    .dashboard, 
    .main, 
    .section:not(.receipt), 
    .tabs, 
    #cartItems, 
    .cart-summary, 
    .cart-total, 
    .payment-methods,
    .modal,
    button,
    #alerts,
    .form-group,
    .btn {
        display: none !important;
        visibility: hidden !important;
    }
    
    @page {
        margin: 10mm;
        size: auto;
    }
    
    body {
        background: white;
        padding: 0;
        margin: 0;
        visibility: hidden;
    }
    
    .container {
        max-width: 100%;
        margin: 0;
        padding: 0;
        visibility: hidden;
    }
    
    .receipt {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
}

@media (max-width: 768px) {
    .main { grid-template-columns: 1fr; }
    .header-top { flex-direction: column; text-align: center; }
    .shop-info { text-align: center; }
    .payment-methods { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="container">
<!-- Header -->
<div class="header no-print">
<div class="header-top">
<div>
<h1>üîß Advanced Repair Shop POS</h1>
<p id="datetime"></p>
</div>
<div class="shop-info">
<h3>üíª Computer Repair Shop</h3>
<p>üìû 077-1234567 | üìß shop@email.com</p>
<p>üìç Colombo, Sri Lanka</p>
</div>
</div>
</div>

<!-- Dashboard -->
<div class="dashboard no-print">
<div class="dash-card sales">
<h3>üìä Today's Sales</h3>
<div class="value" id="todaySales">Rs. 0</div>
</div>
<div class="dash-card weekly">
<h3>üìà Weekly Sales</h3>
<div class="value" id="weeklySales">Rs. 0</div>
</div>
<div class="dash-card monthly">
<h3>üìÖ Monthly Sales</h3>
<div class="value" id="monthlySales">Rs. 0</div>
</div>
<div class="dash-card items">
<h3>üõí Items Sold</h3>
<div class="value" id="itemsSold">0</div>
</div>
<div class="dash-card orders">
<h3>üì¶ Orders</h3>
<div class="value" id="totalOrders">0</div>
</div>
<div class="dash-card stock">
<h3>‚ö†Ô∏è Low Stock</h3>
<div class="value" id="lowStock">0</div>
</div>
</div>

<div class="main">
<!-- Left Section -->
<div class="section no-print">
<!-- Tabs -->
<div class="tabs">
<button class="tab active" onclick="showTab('products')">üñ±Ô∏è Products</button>
<button class="tab" onclick="showTab('add')">‚ûï Add Item</button>
<button class="tab" onclick="showTab('stock')">üì¶ Stock</button>
<button class="tab" onclick="showTab('sales')">üìà Sales Report</button>
<button class="tab" onclick="showTab('customers')">üë• Customers</button>
</div>

<!-- Alerts -->
<div id="alerts"></div>

<!-- Products Tab -->
<div id="tab-products">
<div class="search-bar">
<input type="text" id="searchProduct" placeholder="üîç Search products..." onkeyup="searchProducts()">
</div>
<div id="productGrid" class="product-grid"></div>
</div>

<!-- Add Item Tab -->
<div id="tab-add" class="hidden">
<h2 style="color: #667eea; margin-bottom: 15px;">‚ûï Add New Item</h2>
<div class="form-group">
<label>‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫‡∑ö ‡∂±‡∂∏ / Item Name:</label>
<input type="text" id="newItemName" placeholder="‡∂ã‡∂Ø‡∑è: Wireless Mouse">
</div>
<div class="form-row">
<div class="form-group">
<label>‡∂∏‡∑í‡∂Ω / Price (Rs.):</label>
<input type="number" id="newItemPrice" placeholder="850">
</div>
<div class="form-group">
<label>Stock ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫:</label>
<input type="number" id="newItemStock" placeholder="20" value="10">
</div>
</div>
<div class="form-group">
<label>‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫ / Category:</label>
<select id="newItemCategory">
<option value="accessory">üñ±Ô∏è Accessory</option>
<option value="repair">üõ†Ô∏è Repair Service</option>
<option value="cable">üîå Cables</option>
<option value="storage">üíæ Storage</option>
</select>
</div>
<button class="btn btn-block" onclick="addItem()">üíæ Save Item</button>
</div>

<!-- Stock Tab -->
<div id="tab-stock" class="hidden">
<h2 style="color: #667eea; margin-bottom: 15px;">üì¶ Stock Management</h2>
<div class="form-row" style="margin-bottom: 15px;">
<button class="btn" onclick="exportStock()">üì• Export Stock (CSV)</button>
<button class="btn btn-orange" onclick="checkAllStock()">üîç Check All Stock</button>
</div>
<div id="stockList"></div>
</div>

<!-- Sales Report Tab -->
<div id="tab-sales" class="hidden">
<h2 style="color: #667eea; margin-bottom: 15px;">üìà Sales Report</h2>
<div class="form-row" style="margin-bottom: 15px;">
<div class="form-group">
<label>From Date:</label>
<input type="date" id="reportFrom">
</div>
<div class="form-group">
<label>To Date:</label>
<input type="date" id="reportTo">
</div>
</div>
<div class="form-row" style="margin-bottom: 15px;">
<button class="btn" onclick="generateReport()">üìä Generate Report</button>
<button class="btn btn-blue" onclick="exportSales()">üì• Export Sales (CSV)</button>
</div>
<div class="table-container">
<table id="salesTable">
<thead>
<tr>
<th>Date</th>
<th>Items</th>
<th>Total</th>
<th>Payment</th>
<th>Customer</th>
</tr>
</thead>
<tbody id="salesTableBody"></tbody>
</table>
</div>
</div>

<!-- Customers Tab -->
<div id="tab-customers" class="hidden">
<h2 style="color: #667eea; margin-bottom: 15px;">üë• Customer Management</h2>
<div class="form-row" style="margin-bottom: 15px;">
<div class="form-group">
<label>Customer Name:</label>
<input type="text" id="customerName" placeholder="Name">
</div>
<div class="form-group">
<label>Phone:</label>
<input type="text" id="customerPhone" placeholder="077-1234567">
</div>
</div>
<button class="btn btn-block" onclick="addCustomer()" style="margin-bottom: 15px;">‚ûï Add Customer</button>
<div class="table-container">
<table id="customerTable">
<thead>
<tr>
<th>Name</th>
<th>Phone</th>
<th>Orders</th>
<th>Total Spent</th>
</tr>
</thead>
<tbody id="customerTableBody"></tbody>
</table>
</div>
</div>
</div>

<!-- Right Section - Cart -->
<div class="section">
<h2 style="color: #667eea; margin-bottom: 15px;">üõí Shopping Cart</h2>

<!-- Customer Selection -->
<div class="form-group">
<label>üë§ Customer (Optional):</label>
<select id="cartCustomer">
<option value="">Walk-in Customer</option>
</select>
</div>

<div class="cart-items" id="cartItems"></div>

<!-- Cart Summary -->
<div class="cart-summary">
<div class="summary-row">
<span>Subtotal:</span>
<span>Rs. <span id="subtotal">0</span></span>
</div>
<div class="summary-row">
<span>Discount (%):</span>
<input type="number" id="discountPercent" value="0" min="0" max="100" 
       onchange="calculateTotal()" style="width: 60px; padding: 5px; text-align: right;">
</div>
<div class="summary-row">
<span>Discount Amount:</span>
<span>Rs. <span id="discountAmount">0</span></span>
</div>
<div class="summary-row total">
<span>TOTAL:</span>
<span>Rs. <span id="cartTotal">0</span></span>
</div>
</div>

<div class="cart-total">Rs. <span id="finalTotal">0</span></div>

<!-- Payment Method -->
<div class="form-group">
<label>üí≥ Payment Method:</label>
<div class="payment-methods">
<div class="payment-method selected" onclick="selectPayment('cash', this)">
<span>üíµ</span>
<small>Cash</small>
</div>
<div class="payment-method" onclick="selectPayment('card', this)">
<span>üí≥</span>
<small>Card</small>
</div>
<div class="payment-method" onclick="selectPayment('transfer', this)">
<span>üè¶</span>
<small>Transfer</small>
</div>
</div>
</div>

<button class="btn btn-block" onclick="checkout()">‚úÖ Checkout</button>
<button class="btn btn-red btn-block" onclick="clearCart()" style="margin-top: 10px;">üóëÔ∏è Clear Cart</button>

<!-- Receipt -->
<div id="receipt" class="receipt">
<div class="receipt-header">
<div class="receipt-logo">üîß</div>
<div class="receipt-shop">Computer Repair Shop</div>
<div class="receipt-details">
üìû 077-1234567 | üìß shop@email.com<br>
üìç Colombo, Sri Lanka
</div>
</div>
<div class="receipt-info">
<span>Receipt #: <strong id="receiptNumber"></strong></span>
<span>Date: <strong id="receiptDate"></strong></span>
</div>
<div class="receipt-info">
<span>Customer: <strong id="receiptCustomer"></strong></span>
<span>Payment: <strong id="receiptPayment"></strong></span>
</div>
<div class="receipt-items" id="receiptItems"></div>
<div class="receipt-totals">
<div class="receipt-total-row">
<span>Subtotal:</span>
<span>Rs. <span id="receiptSubtotal"></span></span>
</div>
<div class="receipt-total-row">
<span>Discount:</span>
<span>Rs. <span id="receiptDiscount"></span></span>
</div>
<div class="receipt-total-row final">
<span>TOTAL:</span>
<span>Rs. <span id="receiptTotal"></span></span>
</div>
</div>
<div class="receipt-barcode" id="receiptBarcode"></div>
<div class="receipt-footer">
<p>Thank you for your business! üôè</p>
<p>Warranty: 30 Days | Return Policy: 7 Days</p>
<p>Powered by Advanced POS System</p>
</div>
<button class="btn btn-block no-print" onclick="printReceipt()" style="margin-top: 15px;">üñ®Ô∏è Print Receipt</button>
<button class="btn btn-blue btn-block no-print" onclick="newSale()" style="margin-top: 10px;">üîÑ New Sale</button>
</div>
</div>
</div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>üí≥ Payment Details</h2>
<button class="close-btn" onclick="closeModal()">&times;</button>
</div>
<div class="form-group">
<label>Amount Received:</label>
<input type="number" id="amountReceived" placeholder="Enter amount">
</div>
<div class="form-group">
<label>Balance:</label>
<input type="text" id="balanceAmount" readonly style="background: #f0f0f0;">
</div>
<button class="btn btn-block" onclick="confirmPayment()">‚úÖ Confirm Payment</button>
</div>
</div>

<script>
// ==================== DATA INITIALIZATION ====================
let products = JSON.parse(localStorage.getItem('pos_products')) || [];
let cart = [];
let sales = JSON.parse(localStorage.getItem('pos_sales')) || [];
let customers = JSON.parse(localStorage.getItem('pos_customers')) || [];
let selectedPayment = 'cash';
let discountPercent = 0;

// Default products
if(products.length === 0) {
    products = [
        {id: 1, name: "Wireless Mouse", price: 850, stock: 20, category: "accessory"},
        {id: 2, name: "Keyboard", price: 1200, stock: 15, category: "accessory"},
        {id: 3, name: "USB Cable", price: 350, stock: 50, category: "cable"},
        {id: 4, name: "Mouse Pad", price: 450, stock: 30, category: "accessory"},
        {id: 5, name: "Screen Repair", price: 2500, stock: 999, category: "repair"},
        {id: 6, name: "Virus Remove", price: 800, stock: 999, category: "repair"},
        {id: 7, name: "Windows Install", price: 1500, stock: 999, category: "repair"},
        {id: 8, name: "HDMI Cable", price: 650, stock: 25, category: "cable"},
        {id: 9, name: "USB Drive 32GB", price: 1800, stock: 20, category: "storage"},
        {id: 10, name: "Laptop Charger", price: 3500, stock: 10, category: "accessory"}
    ];
    saveProducts();
}

// ==================== SAVE FUNCTIONS ====================
function saveProducts() {
    localStorage.setItem('pos_products', JSON.stringify(products));
    updateDashboard();
}

function saveSales() {
    localStorage.setItem('pos_sales', JSON.stringify(sales));
    updateDashboard();
}

function saveCustomers() {
    localStorage.setItem('pos_customers', JSON.stringify(customers));
}

// ==================== DASHBOARD ====================
function updateDashboard() {
    const now = new Date();
    const today = now.toDateString();
    
    // Today's Sales
    const todaySales = sales.filter(s => new Date(s.date).toDateString() === today);
    const totalToday = todaySales.reduce((sum, s) => sum + s.total, 0);
    
    // Weekly Sales (last 7 days)
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const weeklySales = sales.filter(s => new Date(s.date) >= weekAgo);
    const totalWeek = weeklySales.reduce((sum, s) => sum + s.total, 0);
    
    // Monthly Sales (last 30 days)
    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    const monthlySales = sales.filter(s => new Date(s.date) >= monthAgo);
    const totalMonth = monthlySales.reduce((sum, s) => sum + s.total, 0);
    
    // Items Sold Today
    const totalItems = todaySales.reduce((sum, s) => sum + s.items.reduce((a, b) => a + b.qty, 0), 0);
    
    // Low Stock
    const lowStock = products.filter(p => p.stock > 0 && p.stock <= 5 && p.stock < 999).length;
    
    document.getElementById('todaySales').textContent = 'Rs. ' + totalToday.toLocaleString();
    document.getElementById('weeklySales').textContent = 'Rs. ' + totalWeek.toLocaleString();
    document.getElementById('monthlySales').textContent = 'Rs. ' + totalMonth.toLocaleString();
    document.getElementById('itemsSold').textContent = totalItems;
    document.getElementById('totalOrders').textContent = sales.length;
    document.getElementById('lowStock').textContent = lowStock;
}

// ==================== DATETIME ====================
setInterval(() => {
    document.getElementById('datetime').textContent = new Date().toLocaleString('si-LK');
}, 1000);

// ==================== TAB SWITCHING ====================
function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('tab-products').classList.add('hidden');
    document.getElementById('tab-add').classList.add('hidden');
    document.getElementById('tab-stock').classList.add('hidden');
    document.getElementById('tab-sales').classList.add('hidden');
    document.getElementById('tab-customers').classList.add('hidden');
    
    document.getElementById('tab-' + tabName).classList.remove('hidden');
    
    if(tabName === 'products') renderProducts();
    if(tabName === 'stock') renderStock();
    if(tabName === 'sales') renderSalesReport();
    if(tabName === 'customers') renderCustomers();
    
    checkAlerts();
}

// ==================== PRODUCTS ====================
function renderProducts() {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = '';
    
    const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
    const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm));
    
    if(filtered.length === 0) {
        grid.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><h3>No Products Found</h3><p>Try different search term or add new items</p></div>';
        return;
    }
    
    filtered.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        if(p.stock === 0) {
            card.classList.add('out');
            card.innerHTML = `
                <span class="category">${p.category}</span>
                <h3>${p.name}</h3>
                <div class="price">Rs. ${p.price.toLocaleString()}</div>
                <div class="stock">‚ùå Out of Stock</div>
            `;
            card.onclick = () => alert('‡∂∏‡∑ô‡∂∏ ‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫ stock ‡∂±‡∑ê‡∂≠!\nStock Management ‡∂ß‡∑ê‡∂∂‡∑ä ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä stock ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.');
        } else if(p.stock <= 5 && p.stock < 999) {
            card.classList.add('low');
            card.innerHTML = `
                <span class="category">${p.category}</span>
                <h3>${p.name}</h3>
                <div class="price">Rs. ${p.price.toLocaleString()}</div>
                <div class="stock">‚ö†Ô∏è Only ${p.stock} left</div>
            `;
            card.onclick = () => addToCart(p.id);
        } else {
            card.innerHTML = `
                <span class="category">${p.category}</span>
                <h3>${p.name}</h3>
                <div class="price">Rs. ${p.price.toLocaleString()}</div>
                <div class="stock">‚úÖ Stock: ${p.stock}</div>
            `;
            card.onclick = () => addToCart(p.id);
        }
        
        grid.appendChild(card);
    });
}

function searchProducts() {
    renderProducts();
}

// ==================== ADD ITEM ====================
function addItem() {
    const name = document.getElementById('newItemName').value.trim();
    const price = parseFloat(document.getElementById('newItemPrice').value);
    const stock = parseInt(document.getElementById('newItemStock').value) || 0;
    const category = document.getElementById('newItemCategory').value;
    
    if(!name || !price) {
        alert('‚ö†Ô∏è ‡∂±‡∂∏ ‡∑É‡∑Ñ ‡∂∏‡∑í‡∂Ω ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!');
        return;
    }
    
    const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
    
    products.push({
        id: newId,
        name: name,
        price: price,
        stock: category === 'repair' ? 999 : stock,
        category: category
    });
    
    saveProducts();
    
    alert('‚úÖ ‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∑Ä‡∑í‡∂∫!\n\n‡∂±‡∂∏: ' + name + '\n‡∂∏‡∑í‡∂Ω: Rs. ' + price.toLocaleString());
    
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemPrice').value = '';
    document.getElementById('newItemStock').value = '10';
    
    showTab('products');
}

// ==================== CART ====================
function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if(!product) return;
    
    if(product.stock === 0) {
        alert('‡∂∏‡∑ô‡∂∏ ‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫ stock ‡∂±‡∑ê‡∂≠!');
        return;
    }
    
    const existingItem = cart.find(item => item.id === productId);
    
    if(existingItem) {
        if(product.stock < 999 && existingItem.qty >= product.stock) {
            alert('‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∑Ä‡∂≠‡∑ä stock ‡∂±‡∑ê‡∂≠!\n‡∂â‡∂≠‡∑í‡∂ª‡∑í: ' + product.stock);
            return;
        }
        existingItem.qty++;
    } else {
        cart.push({...product, qty: 1});
    }
    
    renderCart();
    calculateTotal();
}

function updateCartQty(productId, change) {
    const itemIndex = cart.findIndex(item => item.id === productId);
    if(itemIndex === -1) return;
    
    const item = cart[itemIndex];
    const product = products.find(p => p.id === productId);
    const newQty = item.qty + change;
    
    if(newQty <= 0) {
        cart.splice(itemIndex, 1);
    } else if(product.stock < 999 && newQty > product.stock) {
        alert('‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∑Ä‡∂≠‡∑ä stock ‡∂±‡∑ê‡∂≠!\n‡∂â‡∂≠‡∑í‡∂ª‡∑í: ' + product.stock);
        return;
    } else {
        item.qty = newQty;
    }
    
    renderCart();
    calculateTotal();
}

function removeFromCart(productId) {
    const index = cart.findIndex(item => item.id === productId);
    if(index !== -1) {
        cart.splice(index, 1);
        renderCart();
        calculateTotal();
    }
}

function renderCart() {
    const container = document.getElementById('cartItems');
    container.innerHTML = '';
    
    if(cart.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Cart ‡∂ë‡∂ö ‡∑Ñ‡∑í‡∑É‡∑ä‡∂∫‡∑í</p><p style="font-size: 12px; margin-top: 10px;">‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∂±‡∑ä‡∂±</p></div>';
        return;
    }
    
    cart.forEach(item => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
            <div class="cart-item-info">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">Rs. ${item.price.toLocaleString()} x ${item.qty} = Rs. ${(item.price * item.qty).toLocaleString()}</div>
            </div>
            <div class="cart-controls">
                <button class="qty-btn" onclick="updateCartQty(${item.id}, -1)">-</button>
                <span style="font-weight: bold; min-width: 25px; text-align: center;">${item.qty}</span>
                <button class="qty-btn" onclick="updateCartQty(${item.id}, 1)">+</button>
                <button class="remove-btn" onclick="removeFromCart(${item.id})">√ó</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function calculateTotal() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const total = subtotal - discountAmount;
    
    document.getElementById('subtotal').textContent = subtotal.toLocaleString();
    document.getElementById('discountAmount').textContent = discountAmount.toLocaleString();
    document.getElementById('cartTotal').textContent = total.toLocaleString();
    document.getElementById('finalTotal').textContent = total.toLocaleString();
}

// ==================== PAYMENT ====================
function selectPayment(method, element) {
    selectedPayment = method;
    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
    element.classList.add('selected');
}

// ==================== CHECKOUT ====================
function checkout() {
    if(cart.length === 0) {
        alert('Cart ‡∂ë‡∂ö ‡∑Ñ‡∑í‡∑É‡∑ä‡∂∫‡∑í!\n‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.');
        return;
    }
    
    for(let item of cart) {
        if(item.stock < 999) {
            const product = products.find(p => p.id === item.id);
            if(product.stock < item.qty) {
                alert(item.name + ' ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∑Ä‡∂≠‡∑ä stock ‡∂±‡∑ê‡∂≠!\n‡∂â‡∂≠‡∑í‡∂ª‡∑í: ' + product.stock);
                return;
            }
        }
    }
    
    const total = parseFloat(document.getElementById('finalTotal').textContent.replace(/,/g, ''));
    document.getElementById('amountReceived').value = total;
    document.getElementById('balanceAmount').value = 'Rs. 0';
    document.getElementById('paymentModal').classList.add('show');
}

function closeModal() {
    document.getElementById('paymentModal').classList.remove('show');
}

function confirmPayment() {
    const total = parseFloat(document.getElementById('finalTotal').textContent.replace(/,/g, ''));
    const received = parseFloat(document.getElementById('amountReceived').value);
    
    if(received < total) {
        alert('‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∑Ä‡∂≠‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠!\n‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫: Rs. ' + total.toLocaleString());
        return;
    }
    
    const balance = received - total;
    document.getElementById('balanceAmount').value = 'Rs. ' + balance.toLocaleString();
    
    cart.forEach(item => {
        if(item.stock < 999) {
            const product = products.find(p => p.id === item.id);
            product.stock -= item.qty;
        }
    });
    saveProducts();
    
    const customerName = document.getElementById('cartCustomer').value || 'Walk-in Customer';
    const sale = {
        id: Date.now(),
        date: new Date().toISOString(),
        items: [...cart],
        subtotal: cart.reduce((sum, item) => sum + (item.price * item.qty), 0),
        discount: discountPercent,
        total: total,
        payment: selectedPayment,
        customer: customerName
    };
    sales.push(sale);
    saveSales();
    
    if(customerName !== 'Walk-in Customer') {
        const customer = customers.find(c => c.name === customerName);
        if(customer) {
            customer.orders = (customer.orders || 0) + 1;
            customer.totalSpent = (customer.totalSpent || 0) + total;
            saveCustomers();
        }
    }
    
    generateReceipt(sale, balance);
    
    closeModal();
    cart = [];
    discountPercent = 0;
    document.getElementById('discountPercent').value = '0';
    renderCart();
    calculateTotal();
    renderProducts();
    checkAlerts();
    updateDashboard();
}

// ==================== RECEIPT ====================
function generateReceipt(sale, balance) {
    const receiptNumber = 'INV-' + sale.id.toString().slice(-8);
    
    document.getElementById('receiptNumber').textContent = receiptNumber;
    document.getElementById('receiptDate').textContent = new Date(sale.date).toLocaleString('si-LK');
    document.getElementById('receiptCustomer').textContent = sale.customer;
    document.getElementById('receiptPayment').textContent = sale.payment.toUpperCase();
    
    const receiptItems = document.getElementById('receiptItems');
    receiptItems.innerHTML = '';
    sale.items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'receipt-item';
        div.innerHTML = `
            <span>${item.name} x${item.qty}</span>
            <span>Rs. ${(item.price * item.qty).toLocaleString()}</span>
        `;
        receiptItems.appendChild(div);
    });
    
    document.getElementById('receiptSubtotal').textContent = sale.subtotal.toLocaleString();
    document.getElementById('receiptDiscount').textContent = (sale.subtotal * sale.discount / 100).toLocaleString();
    document.getElementById('receiptTotal').textContent = sale.total.toLocaleString();
    document.getElementById('receiptBarcode').textContent = receiptNumber;
    
    document.getElementById('receipt').classList.add('show');
    document.getElementById('receipt').scrollIntoView({ behavior: 'smooth' });
}

function printReceipt() {
    window.print();
}

function newSale() {
    document.getElementById('receipt').classList.remove('show');
    cart = [];
    renderCart();
    calculateTotal();
}

function clearCart() {
    if(cart.length === 0) {
        alert('Cart ‡∂ë‡∂ö ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∑Ñ‡∑í‡∑É‡∑ä‡∂∫‡∑í!');
        return;
    }
    if(confirm('Cart ‡∂ë‡∂ö clear ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∂Ø?')) {
        cart = [];
        discountPercent = 0;
        document.getElementById('discountPercent').value = '0';
        renderCart();
        calculateTotal();
        document.getElementById('receipt').classList.remove('show');
    }
}

// ==================== STOCK MANAGEMENT ====================
function renderStock() {
    const container = document.getElementById('stockList');
    container.innerHTML = '';
    
    const accessories = products.filter(p => p.category !== 'repair');
    
    if(accessories.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No accessories to manage</p></div>';
        return;
    }
    
    accessories.forEach(p => {
        const div = document.createElement('div');
        div.className = 'stock-item';
        
        let stockColor = p.stock > 10 ? '#28a745' : (p.stock > 0 ? '#ffc107' : '#dc3545');
        
        div.innerHTML = `
            <div class="stock-info">
                <div class="stock-name">${p.name}</div>
                <div class="stock-details">Category: ${p.category} | Price: Rs. ${p.price.toLocaleString()}</div>
                <div class="stock-details">Stock: <span style="color: ${stockColor}; font-weight: bold; font-size: 16px;">${p.stock}</span></div>
            </div>
            <div class="stock-actions">
                <button class="btn btn-small btn-red" onclick="updateStock(${p.id}, -1)">-1</button>
                <button class="btn btn-small" onclick="updateStock(${p.id}, 1)">+1</button>
                <button class="btn btn-small btn-blue" onclick="updateStockBulk(${p.id})">Add Bulk</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function updateStock(productId, change) {
    const product = products.find(p => p.id === productId);
    if(product && product.category !== 'repair') {
        const newStock = product.stock + change;
        if(newStock < 0) {
            alert('Stock 0 ‡∂ß ‡∑Ä‡∂©‡∑è ‡∂Ö‡∂©‡∑î ‡∂ö‡∑Ö ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö!');
            return;
        }
        product.stock = newStock;
        saveProducts();
        renderStock();
        renderProducts();
        checkAlerts();
    }
}

function updateStockBulk(productId) {
    const product = products.find(p => p.id === productId);
    if(!product) return;
    
    const qty = prompt(product.name + ' ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂ö‡∑ú‡∂¥‡∂∏‡∂´ quantity ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∂Ø?\n\n‡∂Ø‡∑ê‡∂±‡∂ß ‡∂á‡∂≠‡∑í stock: ' + product.stock, '10');
    
    if(qty === null) return;
    
    const qtyNum = parseInt(qty);
    if(isNaN(qtyNum) || qtyNum <= 0) {
        alert('‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂Ö‡∂ú‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!');
        return;
    }
    
    product.stock += qtyNum;
    saveProducts();
    renderStock();
    renderProducts();
    checkAlerts();
    
    alert('‚úÖ ' + qtyNum + ' ‡∂í‡∂ö‡∂ö ‡∂ë‡∂ö‡∂≠‡∑î ‡∑Ä‡∑í‡∂∫!\n‡∂±‡∑Ä stock ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫: ' + product.stock);
}

function checkAllStock() {
    const lowStock = products.filter(p => p.stock > 0 && p.stock <= 5 && p.stock < 999);
    const outOfStock = products.filter(p => p.stock === 0);
    
    let message = 'üìä Stock Report\n\n';
    if(outOfStock.length > 0) {
        message += '‚ùå Out of Stock (' + outOfStock.length + '):\n';
        outOfStock.forEach(p => message += '  - ' + p.name + '\n');
    }
    if(lowStock.length > 0) {
        message += '\n‚ö†Ô∏è Low Stock (' + lowStock.length + '):\n';
        lowStock.forEach(p => message += '  - ' + p.name + ' (' + p.stock + ')\n');
    }
    if(outOfStock.length === 0 && lowStock.length === 0) {
        message += '‚úÖ All stock levels are good!';
    }
    
    alert(message);
}

function exportStock() {
    let csv = 'ID,Name,Category,Price,Stock\n';
    products.forEach(p => {
        csv += p.id + ',' + p.name + ',' + p.category + ',' + p.price + ',' + p.stock + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'stock_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
}

// ==================== SALES REPORT ====================
function renderSalesReport() {
    const tbody = document.getElementById('salesTableBody');
    tbody.innerHTML = '';
    
    if(sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No sales records</td></tr>';
        return;
    }
    
    sales.slice().reverse().forEach(sale => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${new Date(sale.date).toLocaleDateString('si-LK')}</td>
            <td>${sale.items.length} items</td>
            <td>Rs. ${sale.total.toLocaleString()}</td>
            <td>${sale.payment.toUpperCase()}</td>
            <td>${sale.customer}</td>
        `;
        tbody.appendChild(tr);
    });
}

function generateReport() {
    const from = document.getElementById('reportFrom').value;
    const to = document.getElementById('reportTo').value;
    
    if(!from || !to) {
        alert('Please select date range!');
        return;
    }
    
    const filtered = sales.filter(s => {
        const date = new Date(s.date).toISOString().slice(0,10);
        return date >= from && date <= to;
    });
    
    const total = filtered.reduce((sum, s) => sum + s.total, 0);
    alert('üìä Report Summary\n\nFrom: ' + from + '\nTo: ' + to + '\nOrders: ' + filtered.length + '\nTotal Sales: Rs. ' + total.toLocaleString());
}

function exportSales() {
    let csv = 'Date,Items,Subtotal,Discount,Total,Payment,Customer\n';
    sales.forEach(s => {
        csv += new Date(s.date).toLocaleDateString('si-LK') + ',' + 
               s.items.length + ',' + 
               s.subtotal + ',' + 
               s.discount + ',' + 
               s.total + ',' + 
               s.payment + ',' + 
               s.customer + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sales_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
}

// ==================== CUSTOMERS ====================
function renderCustomers() {
    const tbody = document.getElementById('customerTableBody');
    const select = document.getElementById('cartCustomer');
    
    tbody.innerHTML = '';
    select.innerHTML = '<option value="">Walk-in Customer</option>';
    
    customers.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${c.name}</td>
            <td>${c.phone}</td>
            <td>${c.orders || 0}</td>
            <td>Rs. ${(c.totalSpent || 0).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
        
        const option = document.createElement('option');
        option.value = c.name;
        option.textContent = c.name;
        select.appendChild(option);
    });
}

function addCustomer() {
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    
    if(!name) {
        alert('Please enter customer name!');
        return;
    }
    
    customers.push({
        name: name,
        phone: phone,
        orders: 0,
        totalSpent: 0
    });
    saveCustomers();
    renderCustomers();
    
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    
    alert('‚úÖ Customer added successfully!');
}

// ==================== ALERTS ====================
function checkAlerts() {
    const alertsDiv = document.getElementById('alerts');
    alertsDiv.innerHTML = '';
    
    const lowStock = products.filter(p => p.stock > 0 && p.stock <= 5 && p.stock < 999);
    const outOfStock = products.filter(p => p.stock === 0);
    
    if(outOfStock.length > 0) {
        alertsDiv.innerHTML += '<div class="alert alert-danger">‚ö†Ô∏è Out of Stock: ' + outOfStock.map(p => p.name).join(', ') + '</div>';
    }
    if(lowStock.length > 0) {
        alertsDiv.innerHTML += '<div class="alert alert-warning">‚ö° Low Stock: ' + lowStock.map(p => p.name + ' (' + p.stock + ')').join(', ') + '</div>';
    }
}

// ==================== INITIALIZATION ====================
window.onload = function() {
    renderProducts();
    renderCart();
    calculateTotal();
    checkAlerts();
    updateDashboard();
    renderCustomers();
    
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('reportFrom').value = today;
    document.getElementById('reportTo').value = today;
};
</script>
</body>
</html>
